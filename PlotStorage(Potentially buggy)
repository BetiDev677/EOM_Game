local playersRemaining = Instance.new("NumberValue")
local PlotManager = require(script.Parent.PlotManager)
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local PlotStore = DataStoreService:GetDataStore("PlotStore")
local Players = game:GetService("Players")
local placeableObjects = ReplicatedStorage.PlaceableObjects
type ObjectInfo = {
	Name: string,
	Cf: {number},
}
local function serializePlot(plot: Model)
	local data = {}
	for _, object in Plot.Objects:GetChildren() do
		local objectCF = plot:GetPivot():ToObjectSpace(object:GetPivot())
		local info: ObjectInfo = {
			Name = object.Name,
			Cf = table.pack(objectCF:GetComponents())
		}
		table.insert(data, info)
	end
	return data
end
local PlotStorage = {}

function PlotStorage.Load(player: Player)
playersRemaining.Value += 1

local success,  data = pcall(function()
 return PlotStore:GetAsync(player.UserId)
end)
if not success then
 warn("Plot data failed to load")
 playersRemaing.Value -= 1
 return
end
local plot = PlotManager.SpawnPlot(player)
if data then
        for _, objectInfo in data do
            local template = placeableObjects:FindFirstChild(objectInfo.Name)
            if template then
                local object = template:Clone()
                local relativeCf = CFrame.new(table.unpack(objectInfo.Cf))
                object:PivotTo(plot:GetPivot():ToWorldSpace(relativeCf))
                object.Parent = plot.Objects
            else
                warn("Missing template for object:", objectInfo.Name)
            end
        end
    end
end

function PlotStorage.Save(player: Player)
	local plot = PlotManager.GetPlot(player)

	if not Players:GetPlayerByUserId(player.UserId) then
		return
	end
	
	local plot= PlotManager.SpawnPlot(player)
	if data then
		for _, objectInfo in data do
			local object = placeableObjects[objectInfo.Name]:Clone()
			local relativeCf = CFrame.new(table.unpack(objectInfo.Cf))
			object:PivotTo(plot:GetPivot():ToWorldSpace(relativeCf))
			object.Parent = plot.Objects
		end
	end
	
	
	local data = serializePlot(plot)
	plot:Destroy()
	local success, errMsg = pcall(function()
		PlotStore:UpdateAsync(player.UserId, data)
    end)
	if not success then 
		warn(errMsg)
	end
	playersRemaining.Value -= 1
end

function PlotStorage.WaitForSave()
	while playersRemaining.Value > 0 do
		playersRemaining.Changed:Wait()
	end
end

return PlotStorage
