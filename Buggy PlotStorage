local ReplicatedStorage = game:GetService("ReplicatedStorage")
local playersRemaining = Instance.new("NumberValue")
local PlotManager = require(script.Parent.PlotManager)
local DataStoreService = game:GetService("DataStoreService")
local PlotStore =  DataStoreService:GetDataStore("PlotStore")
local Players = game:GetService("Players")
local placeableObjects = ReplicatedStorage.PlaceableObjects
type ObjectInfo = {
	Name:string,
	Cf: {number},
}
local function serializePlot(plot:Model)
	local data = {}
	for _, object in plot.Objects:GetChildren() do
		local objectCf = plot.GetPivot():ToObjectSpace(object.GetPivot())
		local info: ObjectInfo = {
			Name = object.Name,
			Cf = table.pack(objectCf:GetComponents())
		}
		table.insert(data, info)
	end
	return data
end

local PlotStorage = {

}
function PlotStorage.Load(player:Player)
	local success, data: {ObjectInfo} = pcall(function()
		return PlotStore:GetAsync(player.UserId)
	end)

	if not success then
		warn(data)
		playersRemaining.Value += 1
		return
	end

	if not Players:GetPlayerByUserId(player.UserId) then
		return
	end

	local plot = PlotManager.SpawnPlot(player)
	if data then
		for _, objectInfo in data do
			local object = placeableObjects[objectInfo.Name]:Clone()
			local relativeCf = CFrame.new(table.unpack(objectInfo.Cf))
			object:PivotTo(plot:GetPivot():ToWorldSpace(relativeCf))
			object.Parent = plot.Objects
		end
	end 

	playersRemaining.Value +=1
end
function PlotStorage.Save(player:Player)
	local plot = PlotManager.GetPlot(player)
	if not plot or not (typeof(plot) == "Instance" and plot:IsADescendantOf(workspace)) then
		playersRemaining.Value -= 1 
		return
	end
	local data = serializePlot(plot)

	local success, errMsg = pcall(function()
		PlotStore:SetAsync(player.UserId, data)
	end)

	if success then
		plot:Destroy()
  else
   warn(errMsg)
	end

	playersRemaining.Value -= 1
end
function PlotStorage.WaitForSave()
	while playersRemaining.Value > 0 do
		playersRemaining.Changed:Wait()
	end
end

return PlotStorage
